{% extends "base.html" %}
{% block title %}Vendas Realizadas{% endblock %}
{% block content %}
<div class="container mt-4">

  <!-- ğŸ“œ CabeÃ§alho -->
  <h2 class="text-center mb-4">ğŸ“œ Vendas Finalizadas</h2>

  <!-- ğŸ” Filtros -->
  <form method="POST" class="row g-3">
    <fieldset class="border p-3 rounded">
      <legend class="float-none w-auto px-2">ğŸ” Filtros</legend>
      <div class="row">
        <div class="col-md-3">
          <label for="status"><strong>Status:</strong></label>
          <select name="status" id="status" class="form-control">
            <option value="">Todos</option>
            <option value="finalizado">âœ… Finalizado</option>
            <option value="cancelado">âŒ Cancelado</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="forma_pagamento"><strong>Forma de Pagamento:</strong></label>
          <select name="forma_pagamento" id="forma_pagamento" class="form-control">
            <option value="">Todos</option>
            <option value="Dinheiro">ğŸ’µ Dinheiro</option>
            <option value="CartÃ£o">ğŸ’³ CartÃ£o</option>
            <option value="PIX">âš¡ PIX</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="fiado"><strong>Fiado:</strong></label>
          <select name="fiado" id="fiado" class="form-control">
            <option value="">Todos</option>
            <option value="true">ğŸ§¾ Fiado</option>
            <option value="false">ğŸ’° NÃ£o fiado</option>
          </select>
        </div>
        <div class="col-md-3 align-self-end">
          <button type="submit" class="btn btn-primary w-100">ğŸ” Buscar</button>
        </div>
      </div>
    </fieldset>
  </form>

  <!-- ğŸ“Š AÃ§Ãµes de relatÃ³rio -->
  <div class="d-flex justify-content-between align-items-center mt-4">
    <a href="{{ url_for('relatorio_vendas') }}" class="btn btn-outline-secondary">
      ğŸ“Š RelatÃ³rio de Vendas
    </a>
  </div>

  <!-- ğŸ“‹ Tabela de pedidos -->
  <div class="table-responsive mt-3">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Total</th>
          <th>Forma de Pagamento</th>
          <th>Status</th>
          <th>Fiado</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody>
        {% for pedido in pedidos %}
        <tr>
          <td>{{ pedido.id }}</td>
          <td><strong>R$ {{ '%.2f' % pedido.total }}</strong></td>
          <td>
            {% if pedido.forma_pagamento %}
              <span class="badge bg-info text-dark">{{ pedido.forma_pagamento }}</span>
            {% else %}
              <span class="badge bg-secondary">âŒ NÃ£o informado</span>
            {% endif %}
          </td>
          <td>
            {% if pedido.status == "finalizado" %}
              <span class="badge bg-success">âœ… Finalizado</span>
            {% elif pedido.status == "pendente" %}
              <span class="badge bg-warning text-dark">â³ Pendente</span>
            {% else %}
              <span class="badge bg-danger">âŒ Cancelado</span>
            {% endif %}
          </td>
          <td>
            {% if pedido.fiado %}
              <span class="badge bg-warning text-dark">ğŸ§¾ Fiado</span>
            {% else %}
              <span class="badge bg-success">ğŸ’° Ã€ vista</span>
            {% endif %}
          </td>
          <td>
            <a href="{{ url_for('cupom', id=pedido.id) }}" class="btn btn-info btn-sm" title="Ver cupom" target="_blank" rel="noopener">
              ğŸ§¾ Cupom
            </a>
                        {% if pedido.status != "cancelado" %}
            <button class="btn btn-warning btn-sm" onclick="cancelarVenda('{{ pedido.id }}')" title="Cancelar venda">
              âŒ Cancelar
            </button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>


<!-- ğŸ”— Scripts -->
<script src="{{ url_for('static', filename='script.js') }}" defer></script>
<script>
  function confirmarExclusao() {
    return confirm("âš ï¸ Tem certeza que deseja excluir TODAS as vendas? Esta aÃ§Ã£o Ã© irreversÃ­vel.");
  }

  function cancelarVenda(id) {
    if (confirm("âŒ Deseja realmente cancelar esta venda?")) {
      fetch(`/cancelar_venda/${id}`, {
        method: "POST"
      }).then(response => response.json())
        .then(data => {
          alert(data.message);
          if (data.success) {
            location.reload();
          }
        })
        .catch(() => {
          alert("Erro ao comunicar com o servidor.");
        });
    }
  }
</script>
{% endblock %}
