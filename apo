from flask import Flask, redirect, render_template, request, url_for, session, jsonify
from models import Caixa, Cliente, Pedido, Produto, db
import json
from datetime import datetime
from flask import render_template, request, redirect, url_for, jsonify

app = Flask(__name__)
app.config["SQLALCHEMY_DATABASE_URI"] = "sqlite:///lanchonete.db"
app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = False
app.secret_key = "sua_chave_super_secreta"

db.init_app(app)

# ---------------------- ROTA PRINCIPAL ---------------------- #
@app.route("/")
def home():
    produtos = Produto.query.all()
    ultimo_pedido = Pedido.query.order_by(Pedido.id.desc()).first()  # ðŸ”¹ Pega o Ãºltimo pedido

    if ultimo_pedido:
        try:
            ultimo_pedido.produtos = json.loads(ultimo_pedido.produtos)
        except json.JSONDecodeError:
            ultimo_pedido.produtos = []

    return render_template("home.html", produtos=produtos, ultimo_pedido=ultimo_pedido)

@app.route("/caixa")
def caixa():
    produtos = Produto.query.all()
    return render_template("caixa.html", produtos=produtos)

# ---------------------- FINALIZAR VENDA ---------------------- #
@app.route("/finalizar_venda", methods=["POST"])
def finalizar_venda():
    produtos_consumidos = []
    total = 0

    for produto in Produto.query.all():
        quantidade = request.form.get(f"quantidade_{produto.id}", type=int)
        if quantidade and quantidade > 0:
            produtos_consumidos.append({"id": produto.id, "nome": produto.nome, "quantidade": quantidade, "preco": produto.preco})
            total += produto.preco * quantidade
            produto.estoque -= quantidade  # ðŸ”¹ Atualiza corretamente o estoque

    forma_pagamento = request.form.get("forma_pagamento", "Dinheiro")  # ðŸ”¹ Define "Dinheiro" como padrÃ£o

    if not produtos_consumidos:
        return "Nenhum produto selecionado", 400

    nova_venda = Pedido(produtos=json.dumps(produtos_consumidos, ensure_ascii=False), total=total, status="finalizado", forma_pagamento=forma_pagamento)
    db.session.add(nova_venda)
    db.session.commit()

    return redirect(url_for("vendas"))

# ---------------------- PROCESSAR VENDA ---------------------- #
@app.route("/processar_venda", methods=["POST"])
def processar_venda():
    pedido_json = request.form.get("pedido")
    forma_pagamento = request.form.get("forma_pagamento", "Dinheiro")  # ðŸ”¹ Definir padrÃ£o caso vazio

    if not pedido_json or pedido_json == "[]":
        return jsonify({"success": False, "message": "Erro: Nenhum produto selecionado."}), 400

    try:
        produtos_vendidos = json.loads(pedido_json)
    except json.JSONDecodeError:
        return jsonify({"success": False, "message": "Erro ao processar os produtos."}), 400

    total = 0
    produtos_processados = []

    for item in produtos_vendidos:
        produto = Produto.query.get(item["id"])
        if produto:
            if produto.estoque >= item["quantidade"]:
                produto.estoque -= item["quantidade"]  # ðŸ”¹ Corrigindo atualizaÃ§Ã£o do estoque
                total += produto.preco * item["quantidade"]
                produtos_processados.append({"id": produto.id, "nome": produto.nome, "preco": produto.preco, "quantidade": item["quantidade"]})
            else:
                return jsonify({"success": False, "message": f"Erro: Estoque insuficiente para {item['nome']}."}), 400
        else:
            return jsonify({"success": False, "message": f"Erro: Produto ID {item['id']} nÃ£o encontrado."}), 404
    db.session.commit()

    nova_venda = Pedido(produtos=json.dumps(produtos_processados, ensure_ascii=False), total=total, status="finalizado", forma_pagamento=forma_pagamento)
    db.session.add(nova_venda)
    db.session.commit()
    return redirect(url_for("cupom", id=nova_venda.id))

@app.route("/cupom/<int:id>")
def cupom(id):
    pedido = Pedido.query.get_or_404(id)
    try:
        pedido.produtos = json.loads(pedido.produtos)  # ðŸ”¹ Convertendo corretamente os produtos
    except (json.JSONDecodeError, TypeError):
        pedido.produtos = []

    return render_template("cupom.html", pedido=pedido)

# ---------------------- ROTA DE VENDAS ---------------------- #
@app.route("/vendas", methods=["GET", "POST"])
def vendas():
    query = Pedido.query
    status_filtro = request.form.get("status")
    pagamento_filtro = request.form.get("forma_pagamento")

    if status_filtro:
        query = query.filter_by(status=status_filtro)
    if pagamento_filtro:
        query = query.filter_by(forma_pagamento=pagamento_filtro)

    pedidos = query.order_by(Pedido.id.desc()).all()

    for pedido in pedidos:
        try:
            pedido.produtos = json.loads(pedido.produtos)
        except json.JSONDecodeError:
            pedido.produtos = []

    return render_template("vendas.html", pedidos=pedidos)

@app.route("/vendas_realizadas")
def vendas_realizadas():
    hoje = datetime.utcnow().date()  # ObtÃ©m a data atual

    pedidos = Pedido.query.filter(db.func.date(Pedido.data) == hoje).all()
    pedidos_finalizados = [p for p in pedidos if p.status == "finalizado"]
    pedidos_cancelados = [p for p in pedidos if p.status == "cancelado"]

    total_finalizadas = len(pedidos_finalizados)
    total_canceladas = len(pedidos_cancelados)

    faturamento_finalizadas = sum(p.total or 0 for p in pedidos_finalizados)
    faturamento_canceladas = sum(p.total or 0 for p in pedidos_cancelados)

    return render_template("vendas_realizadas.html", pedidos=pedidos, 
                           total_finalizadas=total_finalizadas, 
                           total_canceladas=total_canceladas, 
                           faturamento_finalizadas=faturamento_finalizadas, 
                           faturamento_canceladas=faturamento_canceladas)

# ---------------------- CANCELAR VENDA ---------------------- #
@app.route("/cancelar_venda/<int:id>", methods=["PUT"])
def cancelar_venda(id):
    pedido = Pedido.query.get_or_404(id)

    if pedido.status == "cancelado":
        return {"success": False, "message": "Venda jÃ¡ estÃ¡ cancelada."}, 400

    produtos_vendidos = json.loads(pedido.produtos)

    for item in produtos_vendidos:
        produto = Produto.query.get(item["id"])
        if produto:
            produto.estoque += item["quantidade"]  # ðŸ”¹ Restaurando corretamente o estoque

    pedido.status = "cancelado"
    db.session.commit()
    return {"success": True}, 200

# ---------------------- ROTA DE ESTOQUE ---------------------- #
@app.route("/estoque")
def estoque():
    produtos = Produto.query.all()
    return render_template("estoque.html", produtos=produtos)

# ---------------------- ADICIONAR PRODUTO ---------------------- #
@app.route("/adicionar_produto", methods=["POST"])
def adicionar_produto():
    nome = request.form["nome"]
    preco = float(request.form["preco"])
    estoque = int(request.form["estoque"])

    produto_existente = Produto.query.filter_by(nome=nome).first()
    if produto_existente:
        produto_existente.estoque += estoque
    else:
        novo_produto = Produto(nome=nome, preco=preco, estoque=estoque)
        db.session.add(novo_produto)

    db.session.commit()
    return redirect(url_for("estoque"))

@app.route("/produto/<int:id>")
def ver_produto(id):
    produto = Produto.query.get_or_404(id)
    return render_template("ver_produto.html", produto=produto)

@app.route("/editar_produto/<int:id>", methods=["GET", "POST"])
def editar_produto(id):
    produto = Produto.query.get_or_404(id)

    if request.method == "POST":
        produto.nome = request.form["nome"]
        produto.preco = float(request.form["preco"])
        produto.estoque = int(request.form["estoque"])
        db.session.commit()
        return redirect(url_for("estoque"))
    return render_template("editar_produto.html", produto=produto)

@app.route("/excluir_produto/<int:id>", methods=["POST"])
def excluir_produto(id):
    produto = Produto.query.get_or_404(id)

    if not produto:
        return jsonify({"success": False, "message": "Produto nÃ£o encontrado."}), 404

    db.session.delete(produto)
    db.session.commit()
    return redirect(url_for("estoque"))

@app.route("/abrir_caixa", methods=["POST"])
def abrir_caixa():
    saldo_inicial = request.form.get("saldo_inicial", type=float)

    if saldo_inicial is None or saldo_inicial < 0:
        return jsonify({"success": False, "message": "Saldo inicial invÃ¡lido."}), 400

    caixa_aberto = Caixa.query.filter_by(status="aberto").first()
    if caixa_aberto:
        return jsonify({"success": False, "message": "Erro: JÃ¡ existe um caixa aberto. Feche o caixa atual antes de abrir um novo."}), 400

    novo_caixa = Caixa(saldo_inicial=saldo_inicial, saldo_atual=saldo_inicial, status="aberto")
    db.session.add(novo_caixa)
    db.session.commit()
    return redirect(url_for("controle_caixa"))

@app.route("/fechar_caixa/<int:id>", methods=["POST"])
def fechar_caixa(id):
    caixa = Caixa.query.get_or_404(id)
    valor_gaveta = request.form.get("valor_gaveta", type=float)

    if valor_gaveta is None or valor_gaveta < 0:
        return jsonify({"success": False, "message": "Valor na gaveta invÃ¡lido."}), 400
    saldo_esperado = caixa.saldo_inicial  # ðŸ”¹ Removemos vendas finalizadas
    diferenca = valor_gaveta - saldo_esperado
    caixa.saldo_final = valor_gaveta
    caixa.diferenca = diferenca
    caixa.status = "fechado"
    caixa.data_fechamento = datetime.utcnow()

    db.session.commit()
    return redirect(url_for("controle_caixa"))

@app.route("/controle_caixa")
def controle_caixa():
    hoje = datetime.utcnow().date()  # ObtÃ©m a data atual
    caixa_aberto = Caixa.query.filter_by(status="aberto").first()
    pedidos_finalizados = Pedido.query.filter(
        db.func.date(Pedido.data) == hoje, 
        Pedido.status == "finalizado"
    ).all()
    saldo_vendas = sum(p.total or 0 for p in pedidos_finalizados)
    saldo_total_caixa = (caixa_aberto.saldo_inicial if caixa_aberto else 0) + saldo_vendas

    return render_template("caixa.html", caixas=Caixa.query.order_by(Caixa.data_abertura.desc()).all(),
                           caixa_aberto=caixa_aberto, saldo_vendas=saldo_vendas, saldo_total_caixa=saldo_total_caixa)


@app.route("/dashboard_admin")
def dashboard_admin():
    # EstatÃ­sticas gerais
    total_produtos = Produto.query.count()
    total_pedidos = Pedido.query.count()
    
    pedidos_finalizados = Pedido.query.filter_by(status="finalizado").count()
    pedidos_cancelados = Pedido.query.filter_by(status="cancelado").count()

    faturamento_total = db.session.query(db.func.sum(Pedido.total)).scalar() or 0

    # Ãšltimos pedidos
    pedidos_recentes = Pedido.query.order_by(Pedido.data.desc()).limit(5).all()

    return render_template("dashboard_admin.html", total_produtos=total_produtos,
                           total_pedidos=total_pedidos, pedidos_finalizados=pedidos_finalizados,
                           pedidos_cancelados=pedidos_cancelados, faturamento_total=faturamento_total,
                           pedidos_recentes=pedidos_recentes)

# ---------------------- INICIAR APLICACÃƒO ---------------------- #
if __name__ == "__main__":
    with app.app_context():
        db.create_all()
    app.run(debug=True)





